# 26. Резервное копирование

## Задание

[Методичка](https://docs.google.com/document/d/1L0VtVCn2tXmC0Pirlfhnr6rEpOANbP-C/edit?usp=share_link&ouid=104106368295333385634&rtpof=true&sd=true)

Настроить стенд Vagrant с двумя виртуальными машинами: backupserver и client.
Настроить удаленный бекап каталога /etc c сервера client при помощи borgbackup. Резервные копии должны соответствовать следующим критериям:
* директория для резервных копий /var/backup. Это должна быть отдельная точка монтирования. В данном случае для демонстрации размер не принципиален, достаточно будет и 2GB;
* репозиторий дле резервных копий должен быть зашифрован ключом или паролем - на ваше усмотрение;
* имя бекапа должно содержать информацию о времени снятия бекапа;
* глубина бекапа должна быть год, хранить можно по последней копии на конец месяца, кроме последних трех. Последние три месяца должны содержать копии на каждый день. Т.е. должна быть правильно настроена политика удаления старых бэкапов;
* резервная копия снимается каждые 5 минут. Такой частый запуск в целях демонстрации;
* написан скрипт для снятия резервных копий. Скрипт запускается из соответствующей Cron джобы, либо systemd timer-а - на ваше усмотрение;
* настроено логирование процесса бекапа. Для упрощения можно весь вывод перенаправлять в logger с соответствующим тегом. Если настроите не в syslog, то обязательна ротация логов.

Запустите стенд на 30 минут.
Убедитесь что резервные копии снимаются.
Остановите бекап, удалите (или переместите) директорию /etc и восстановите ее из бекапа.

## Script

```bash
scriptreplay --timing=timing.log --divisor=5 script.log
```

## Tutorial

```bash
vagrant up
vagrant ssh client
sudo -i

export BACKUPSERVER=192.168.59.10

# --- инициализации репозитория для хранения резервных копии
borg init --encryption=repokey borg@$BACKUPSERVER:/var/backup/

# --- создание резервной копии
borg create --stats --list borg@$BACKUPSERVER:/var/backup/::"etc-{now:%Y-%m-%d_%H:%M:%S}" /etc

# --- отобразить список резервных копий
borg list borg@$BACKUPSERVER:/var/backup/

# --- отобразить список файлов резервной копии
export ARCNAME=etc-2023-08-14_04:48:57
borg list borg@$BACKUPSERVER:/var/backup/::$ARCNAME

# --- извлечь файл из копии в текущую директорию
borg extract borg@$BACKUPSERVER:/var/backup/::$ARCNAME etc/hostname
cat ./etc/hostname 
client
```

Автоматическое резервирвание запущено через ansible (см. *playbooks/client.yaml*).
Команда удаления архивов: `ExecStart=/bin/borg prune --keep-hourly 5 ${REPO}`: не удалять крайний часовой архив в течении 5 часов.

Для проверки необходимо оставить работающими виртуальные машины в на "стыке" часа и выполнить команды:
```bash
vagrant ssh client
sudo -i
export BACKUPSERVER=192.168.59.10
borg list borg@$BACKUPSERVER:/var/backup/
Enter passphrase for key ssh://borg@192.168.59.10/var/backup: 
# etc-2023-08-14_05:59:31              Mon, 2023-08-14 05:59:32 [b5e356f4f0319f49f570259109655134682393160cdf3532c927ff196ad073fe]
# etc-2023-08-14_06:10:57              Mon, 2023-08-14 06:10:58 [19f395ff7305b2f31c6d698fe23ca0e943aae21f2aafa303280221810658665a]
```
